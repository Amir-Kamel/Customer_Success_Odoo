<odoo>
  <!-- List view -->
  <record id="view_customer_success_list" model="ir.ui.view">
    <field name="name">customer.success.list</field>
    <field name="model">customer.success</field>
    <field name="arch" type="xml">
      <list string="Customer Success">
        <field name="name"/>
        <field name="partner_id"/>
        <field name="team_id"/>
        <field name="stage_id"/>
        <field name="assigned_user_id"/>
      </list>
    </field>
  </record>

  <!-- Kanban view -->
  <record id="view_customer_success_kanban" model="ir.ui.view">
    <field name="name">customer.success.kanban</field>
    <field name="model">customer.success</field>
    <field name="arch" type="xml">
      <kanban default_group_by="stage_id" class="o_kanban_card">
        <field name="name"/>
        <field name="partner_id"/>
        <field name="team_id"/>
        <field name="stage_id"/>
        <field name="assigned_user_id"/>
        <field name="health_percentage"/>
        <field name="priority"/>
          <field name="lost_reason_label"/>
        <templates>
          <t t-name="kanban-box">
            <div t-attf-class="oe_kanban_global_click o_kanban_record d-flex" style="min-height:140px;">
              <div class="card w-100">
                <div class="card-body d-flex flex-column" style="padding:0.75rem;">
                  <h5 class="card-title mb-1" style="font-size:1rem; line-height:1.1;">
                    <field name="name"/>
                  </h5>

                <div class="card-text mb-1 text-truncate" style="font-size:0.9rem; display:flex; gap:6px;">
                    <t t-if="record.partner_id.value">
                      <field name="partner_id" widget="many2one_avatar_user"/>
                      <field name="partner_id" options="{'no_open': True}" nolabel="1"/>
                        </t>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-1" style="font-size:0.85rem;">
                  <field name="team_id"/>
                  <div style="display:flex; align-items:center; gap:6px;">
                      <t t-if="record.assigned_user_id.value">
                      <field name="assigned_user_id" widget="many2one_avatar_user"/>
                      <field name="assigned_user_id" options="{'no_open': True}" nolabel="1"/>
                        </t>
                  </div>
                </div>


                  <div class="mb-1" style="font-size:0.85rem;">
                      <t t-if="record.tag_ids.value">
                    <field name="tag_ids" widget="many2many_tags" options="{'color_field':'color'}"/>
                      </t>
                </div>


            <!-- Combined row: Priority + Health + Activities -->
            <div class="d-flex align-items-center justify-content-between mb-1">

                <!-- Left: Priority -->
                <div class="d-flex align-items-center mb-1" style="gap:8px;">
                    <field name="priority" widget="priority"/>

                    <field name="activity_ids" widget="kanban_activity" options="{'display_email': True}"/>
                </div>

                <!-- Right: Health % -->
                <div class="small text-muted mb-1">
                    <t t-esc="record.health_percentage.raw_value
                        ? ((record.health_percentage.raw_value % 1 === 0)
                            ? record.health_percentage.raw_value
                            : record.health_percentage.raw_value.toFixed(1))
                        : 0"/>%

                </div>
            </div>


                <!-- Compute percentage and assign Bootstrap colors -->
                <t t-set="pct_int" t-value="record.health_percentage.value || 0"/>
                <t t-set="bar_class"
                   t-value="pct_int &lt;= 25 ? 'bg-danger' : (pct_int &lt;= 50 ? 'bg-warning' : (pct_int &lt;= 75 ? 'bg-primary' : 'bg-success'))"/>

                  <div class="progress mb-1" style="height:10px; border-radius:6px; overflow:hidden;">
                    <div role="progressbar"
                         t-att-class="'progress-bar ' + bar_class"
                         t-att-style="'width: ' + pct_int + '%;'"
                         t-att-aria-valuenow="pct_int"
                         aria-valuemin="0" aria-valuemax="100">
                    </div>
                  </div>
                     <!-- Lost Reason Note -->
                        <t t-if="record.lost_reason_label.value">
                                <t t-set="reason" t-value="record.lost_reason_label.value or ''"/>
                                <t t-set="clean_reason" t-value="reason.startsWith('Churned Reason:') ? reason.slice(15).trim() : reason"/>

                                <div class="text-muted small fst-italic" style="font-size:0.8rem; color:#a33;">
                                  <i class="fa fa-exclamation-circle me-1"></i>
                                  <t t-esc="clean_reason"/>
                                </div>
                        </t>
                </div>
              </div>
            </div>
          </t>
        </templates>
      </kanban>
    </field>
  </record>



 <record id="view_customer_success_form" model="ir.ui.view">
  <field name="name">customer.success.form</field>
  <field name="model">customer.success</field>
  <field name="arch" type="xml">
    <form string="Customer Success">
      <header>
        <button name="action_set_won" string="Achieved" type="object" class="btn-success"
        invisible="not active or stage_id.name == 'Achieved' or health_percentage == 100"/>
        <button name="action_set_lost" string="Churned" type="object" class="btn-danger"
        invisible="not active or stage_id.name == 'Churned' or health_percentage == 0"/>
        <button name="action_set_lost"
        string="Set Churned Reason"
        type="object"
        class="o_form_button_custom_warning btn btn-outline-warning"
        invisible="lost_reason_id or health_percentage != 0"/>

          <field name="lost_reason_label"
       readonly="1"
       class="o_form_status"
       style="font-weight:bold;"
       invisible="not lost_reason_label"/>

        <field name="stage_id" widget="statusbar" options="{'clickable': '1', 'fold_field': 'fold'}"/>
      </header>

      <sheet>
          <div class="oe_button_box" name="button_box">
             <button name="action_open_related_crm_lead"
                string="Related CRM Lead"
                type="object"
                icon="fa-briefcase"
                class="oe_stat_button"
                invisible="related_crm_lead_id == False"/>
          </div>

          <widget name="web_ribbon" title="Churned" bg_color="text-bg-danger" invisible="health_percentage != 0"/>
               <widget name="web_ribbon" title="Achieved" invisible="health_percentage != 100"/>
        <!-- Headline Title -->
        <div class="oe_title">
          <h1>
                <field name="name"/>
          </h1>
        </div>

        <!-- Two Columns Layout -->
        <group>
          <group>
            <field name="partner_id" widget="many2one_avatar_user"/>
            <field name="phone"/>
            <field name="email"/>
            <field name="renewal_date"/>

          </group>
          <group>
            <field name="team_id"/>
            <field name="assigned_user_id" widget="many2one_avatar_user"/>
            <field name="related_crm_lead_id"/>
             <label for="tag_ids">Tags</label>
            <div class="o_lead_opportunity_form_inline_fields gap:6px;">
                <field name="tag_ids" widget="many2many_tags" options="{'color_field': 'color', 'no_create_edit': True}" nolabel="1" class="oe_inline"/>
                <field name="priority" widget="priority" nolabel="1" class="oe_inline align-top"/>
            </div>
          </group>
        </group>


        <!-- Notebook Tabs -->
        <notebook>
          <page string="Feedback">
            <field name="last_feedback" widget="html"/>
          </page>
        </notebook>
      </sheet>
                    <chatter reload_on_post="True"/>

    </form>
  </field>
</record>

  <!-- Search -->
  <record id="view_customer_success_search" model="ir.ui.view">
    <field name="name">customer.success.search</field>
    <field name="model">customer.success</field>
    <field name="arch" type="xml">
      <search string="Customer Success">
        <field name="name"/>
        <field name="partner_id"/>
        <field name="team_id"/>
        <field name="stage_id"/>
        <field name="assigned_user_id"/>
        <field name="tag_ids"/>
          <filter string="On Going" name="filter_on_going" domain="[('stage_id.name','!=',['Achieved','Churned'])]"/>
        <filter string="Achieved" name="filter_won" domain="[('stage_id.name','=','Achieved')]"/>
        <filter string="Churned" name="filter_lost" domain="[('stage_id.name','=','Churned')]"/>

            <group expand="0" string="Group By">
        <filter string="Client" name="group_partner" context="{'group_by':'partner_id'}"/>
        <filter string="Team" name="group_team" context="{'group_by':'team_id'}"/>
        <filter string="Success Partner" name="group_user" context="{'group_by':'assigned_user_id'}"/>
        <filter string="Tags" name="group_tags" context="{'group_by':'tag_ids'}"/>
      </group>
      </search>
    </field>
  </record>

  <!-- Action -->
  <record id="action_customer_success" model="ir.actions.act_window">
    <field name="name">Customer Success</field>
    <field name="res_model">customer.success</field>
    <field name="view_mode">kanban,list,form</field>
    <field name="view_id" ref="view_customer_success_kanban"/>

    <field name="help" type="html">
      <p class="o_view_nocontent_smiling_face">
        Create and manage Customer Success records.
      </p>
    </field>
  </record>

</odoo>

